<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Snapshot</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 2rem;
      background: #e8e8e8;
    }
    .chart-wrapper {
      width: 1200px;
      height: 600px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
    }
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #eee;
    }
    .chart-header h2 {
      margin: 0;           
      font-size: 1.rem;
      font-weight: 800;
      color: #555;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .chart-select {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.4rem 0.75rem;
      font-size: 0.875rem;
    }
    .chart-container {
      flex: 1;
      position: relative;
      min-height: 0;
    }
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .chart-section {
      margin-bottom: 1.5rem;
    }
    .chart-section[data-visible="false"] {
      display: none;
    }
    .projection-inputs {
      padding: 0.5rem 1.25rem;
      border-bottom: 1px solid #eee;
      font-size: 0.7rem;
    }
    .projection-inputs-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.6rem 1rem;
      margin-bottom: 0.5rem;
    }
    .projection-inputs-row:last-child {
      margin-bottom: 0;
    }
    .projection-inputs-row.row1,
    .projection-inputs-row.row2 {
      justify-content: center;
    }
    .projection-inputs-row .spacer {
      width: 3rem;
    }
    .projection-inputs label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .projection-inputs input {
      width: 3.75rem;
      padding: 0.2rem 0.35rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.7rem;
      text-align: right;
    }
    .projection-inputs input.input-narrow {
      width: 1.875rem;
    }
    .projection-inputs input.input-mc,
    .chart-header input.input-mc {
      width: 1.5rem;
      text-align: right;
    }
    .projection-inputs .net-return {
      color: #555;
      font-weight: 500;
    }
    .note {
      font-size: 0.75rem;
      color: #999;
      margin-top: 2rem;
    }
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-left: 0.15rem;
      width: 0.85em;
      height: 0.85em;
      border-radius: 50%;
      border: 1px solid #888;
      font-size: 0.55em;
      font-style: normal;
      font-weight: 400;
      color: #666;
      cursor: help;
      vertical-align: middle;
    }
    .info-icon .info-tooltip {
      visibility: hidden;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(100% + 8px);
      width: 320px;
      padding: 0.75rem 1rem;
      background: #333;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 400;
      line-height: 1.5;
      text-align: left;
      white-space: normal;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 100;
    }
    .info-icon:hover .info-tooltip {
      visibility: visible;
    }
  </style>
</head>
<body>
  <div id="chart-sections">
    <section id="chart-net-investments" class="chart-section" data-chart-id="net-investments" data-visible="true">
      <div class="chart-wrapper chart-full-width">
        <div class="chart-header">
          <h2>Net Investments</h2>
          <select id="netInvestments-viewSelect" class="chart-select">
            <option value="1month" selected>1 month</option>
            <option value="90days">90 days</option>
            <option value="year">This year</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="netInvestments-canvas"></canvas>
        </div>
      </div>
    </section>
    <section id="chart-wealth-projection" class="chart-section" data-chart-id="wealth-projection" data-visible="true">
      <div class="chart-wrapper chart-full-width">
        <div class="chart-header">
          <h2>Wealth projection</h2>
        </div>
        <div class="projection-inputs">
          <div class="projection-inputs-row row1">
            <label>Pre Tax Return <input type="text" class="input-narrow" id="wealth-preTaxReturn" value="7.30">%</label>
            <label>State/Fed Tax Rate <input type="text" class="input-narrow" id="wealth-taxRate" value="30.00">%</label>
            <label class="net-return">Net Return <span id="wealth-netReturn">4.02</span>%</label>
            <label>Cost of Living $<input type="text" id="wealth-costOfLiving" value="1500000"></label>
            <label>Inflation <input type="text" class="input-narrow" id="wealth-inflation" value="3.0">%</label>
            <label>Home Appreciation <input type="text" class="input-narrow" id="wealth-homeAppreciation" value="3">%</label>
          </div>
          <div class="projection-inputs-row row2">
            <span style="font-weight: bold;">Downsize House</span>
            <label>Year <input type="text" class="input-narrow" id="wealth-downsizeHouseYear" value="2037"></label>
            <label>Amount $<input type="text" id="wealth-downsizeHouseAmount" value="10000000"></label>
            <span class="spacer"></span>
            <span style="font-weight: bold;">Downsize COL</span>
            <label>Year <input type="text" class="input-narrow" id="wealth-downsizeCOLYear" value="2037"></label>
            <label>Amount $<input type="text" id="wealth-downsizeCOLAmount" value="-200000"></label>
            <button type="button" id="wealth-reset" class="chart-select" style="margin-left: 1rem;">Reset</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="wealthProjection-canvas"></canvas>
        </div>
        <details style="margin: 1rem 1.25rem; font-size: 0.8rem;">
          <summary style="cursor: pointer;">Year-by-year breakdown</summary>
          <div id="wealth-breakdown" style="margin-top: 0.5rem; max-height: 200px; overflow: auto;"></div>
        </details>
      </div>
    </section>
    <section id="chart-wealth-montecarlo" class="chart-section" data-chart-id="wealth-montecarlo" data-visible="true">
      <div class="chart-wrapper chart-full-width">
        <div class="chart-header">
          <h2>Monte Carlo<span class="info-icon">i<span class="info-tooltip">This simulation runs thousands of parallel scenarios (default 10,000) to project your wealth over time. Each scenario uses different random draws for each year.

Investment returns: Drawn from a normal distribution around your assumed net return, with volatility you specify (default 17%). Returns and inflation are correlated (default -0.3) to model stagflation.

Real estate: Home value grows each year by a random appreciation rate centered on your assumed rate, with volatility you specify (default 5%).

Inflation: Each year's inflation is random (normal around your assumed rate, with default 1.5% volatility and a 1% floor). Cost of living rises with this simulated inflation in each scenario.

For each scenario, net investments, real estate, and net worth are projected year by year. The chart shows the 10th, 25th, 50th, 75th, and 90th percentiles at each year, plus 5 sample paths. Downsize house and COL changes are applied in the year you specify.</span></span></h2>
          <label style="font-size: 0.7rem;">Simulations <input type="text" class="input-narrow" id="mc-simulations" value="10000" style="width: 3rem;"></label>
          <label style="font-size: 0.7rem;">Return volatility <input type="text" class="input-mc" id="mc-returnVolatility" value="17">%</label>
          <label style="font-size: 0.7rem;">Home appreciation vol. <input type="text" class="input-mc" id="mc-homeApprecVolatility" value="5">%</label>
          <label style="font-size: 0.7rem;">Inflation vol. <input type="text" class="input-mc" id="mc-inflationVolatility" value="1.5">%</label>
          <label style="font-size: 0.7rem;">Infl.–return corr. <input type="text" class="input-mc" id="mc-inflationReturnCorr" value="-0.3"></label>
          <button type="button" id="mc-rerun" class="chart-select" style="margin-left: 0.5rem;">Rerun</button>
          <button type="button" id="mc-reset" class="chart-select" style="margin-left: 0.5rem;">Reset</button>
        </div>
        <div class="chart-container">
          <canvas id="wealthMonteCarlo-canvas"></canvas>
        </div>
        <details style="margin: 1rem 1.25rem; font-size: 0.8rem;">
          <summary style="cursor: pointer;">Year-by-year breakdown (50% Net Investment path)</summary>
          <div id="mc-breakdown" style="margin-top: 0.5rem; max-height: 200px; overflow: auto;"></div>
        </details>
      </div>
    </section>
  </div>
  <p class="note">Run a local server from this folder to load the CSV. Example: <code>python -m http.server 8000</code> then open <code>http://localhost:8000/financial-snapshot.html</code></p>

  <script>
    const csvPath = 'CSV Working prototype - Sheet1.csv';

    // Shared helpers
    function parseDate(str) {
      const [m, d, y] = str.split('/').map(Number);
      return new Date(y, m - 1, d);
    }

    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    function formatShortDate(dateStr) {
      const d = parseDate(dateStr);
      return monthNames[d.getMonth()] + ' ' + d.getDate();
    }

    function movingAverage(values, window) {
      const result = [];
      for (let i = 0; i < values.length; i++) {
        if (i < window - 1) {
          result.push(null);
        } else {
          const slice = values.slice(i - window + 1, i + 1);
          result.push(slice.reduce((a, b) => a + b, 0) / window);
        }
      }
      return result;
    }

    // Chart registry: add charts here to show/hide or reorder
    const chartRegistry = {
      'net-investments': document.getElementById('chart-net-investments'),
      'wealth-projection': document.getElementById('chart-wealth-projection'),
      'wealth-montecarlo': document.getElementById('chart-wealth-montecarlo')
    };

    function normalRandom(mean, stdDev) {
      const u1 = Math.random(), u2 = Math.random();
      if (u1 < 1e-10) return mean;
      const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
      return mean + z * stdDev;
    }

    function percentile(arr, p) {
      const sorted = [...arr].sort((a, b) => a - b);
      const idx = (p / 100) * (sorted.length - 1);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      return lo === hi ? sorted[lo] : sorted[lo] + (idx - lo) * (sorted[hi] - sorted[lo]);
    }

    function setChartVisible(chartId, visible) {
      const el = chartRegistry[chartId];
      if (el) el.setAttribute('data-visible', visible);
    }

    function isChartVisible(chartId) {
      return chartRegistry[chartId]?.getAttribute('data-visible') !== 'false';
    }

    // Net Investments chart
    const netInvestmentsChart = {
      id: 'net-investments',
      instance: null,
      rawData: [],

      filterData(view) {
        const d = this.rawData;
        if (view === '1month') {
          const latest = d[d.length - 1]?.dateObj;
          if (!latest) return { labels: [], values: [] };
          const cutoff = new Date(latest);
          cutoff.setMonth(cutoff.getMonth() - 1);
          const filtered = d.filter(r => r.dateObj >= cutoff);
          return { labels: filtered.map(r => formatShortDate(r.dateStr)), values: filtered.map(r => r.value) };
        } else if (view === '90days') {
          const latest = d[d.length - 1]?.dateObj;
          if (!latest) return { labels: [], values: [] };
          const cutoff = new Date(latest);
          cutoff.setDate(cutoff.getDate() - 90);
          const filtered = d.filter(r => r.dateObj >= cutoff);
          return { labels: filtered.map(r => formatShortDate(r.dateStr)), values: filtered.map(r => r.value) };
        } else {
          const latest = d[d.length - 1]?.dateObj;
          if (!latest) return { labels: [], values: [] };
          const yearStart = new Date(latest.getFullYear(), 0, 1);
          const filtered = d.filter(r => r.dateObj >= yearStart && r.dateObj.getDay() === 6);
          return { labels: filtered.map(r => formatShortDate(r.dateStr)), values: filtered.map(r => r.value) };
        }
      },

      update(view) {
        const { labels, values } = this.filterData(view);
        const maWindow = (view === '1month' || view === '90days') ? 7 : 4;
        const maValues = movingAverage(values, maWindow);
        const goalLine = labels.map(() => 45000000);
        if (this.instance) {
          this.instance.data.labels = labels;
          this.instance.data.datasets[0].data = values;
          this.instance.data.datasets[1].data = maValues;
          this.instance.data.datasets[2].data = goalLine;
          this.instance.update();
        }
      },

      show() { setChartVisible(this.id, true); },
      hide() { setChartVisible(this.id, false); },

      async init() {
        const response = await fetch(csvPath);
        const text = await response.text();
        const lines = text.trim().split('\n');
        const data = lines.slice(1).filter(line => line.trim());

        this.rawData = data.map(line => {
          const cols = line.split(',');
          const dateStr = cols[0];
          return { dateStr, dateObj: parseDate(dateStr), value: parseFloat(cols[4]) || 0 };
        });

        const view = document.getElementById('netInvestments-viewSelect').value;
        const { labels, values } = this.filterData(view);
        const maWindow = (view === '1month' || view === '90days') ? 7 : 4;
        const maValues = movingAverage(values, maWindow);
        const goalLine = labels.map(() => 45000000);

        const ctx = document.getElementById('netInvestments-canvas').getContext('2d');
        this.instance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: values,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14, 165, 233, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 8,
            pointBackgroundColor: '#0ea5e9',
            borderWidth: 4,
          }, {
            data: maValues,
            borderColor: 'rgba(14, 165, 233, 0.5)',
            fill: false,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 0,
            borderWidth: 2,
          }, {
            data: goalLine,
            borderColor: '#22c55e',
            fill: false,
            tension: 0,
            pointRadius: 0,
            pointHoverRadius: 0,
            borderWidth: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          layout: { padding: 10 },
          plugins: {
            legend: { display: false },
            tooltip: {
              filter: (item) => item.datasetIndex === 0,
              animation: { duration: 0 },
              callbacks: {
                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
              }
            },
          },
          scales: {
            x: {
              title: { display: false },
              grid: { display: false },
              ticks: { color: '#555', font: { size: 11 } },
            },
            y: {
              min: 35000000,
              max: 45000000,
              title: { display: true, text: 'Net Investments ($)', color: '#555', font: { size: 11 } },
              grid: { color: 'rgba(0,0,0,0.06)' },
              ticks: {
                color: '#555',
                font: { size: 11 },
                stepSize: 2500000,
                callback: value => '$' + (value / 1000000).toFixed(1) + 'M'
              }
            }
          }
        }
      });

        document.getElementById('netInvestments-viewSelect').addEventListener('change', (e) => {
          this.update(e.target.value);
        });
      }
    };

    // Wealth Projection chart
    const wealthProjectionDefaults = {
      preTaxReturn: '7.30',
      taxRate: '30.00',
      costOfLiving: '1500000',
      inflation: '3.0',
      homeAppreciation: '3',
      downsizeHouseYear: '2037',
      downsizeHouseAmount: '10000000',
      downsizeCOLYear: '2037',
      downsizeCOLAmount: '-200000'
    };
    const WEALTH_STORAGE_KEY = 'financial-snapshot-wealth-inputs';

    const wealthProjectionChart = {
      id: 'wealth-projection',
      instance: null,
      startYear: 2026,
      numYears: 41,

      loadStored() {
        try {
          const stored = localStorage.getItem(WEALTH_STORAGE_KEY);
          return stored ? JSON.parse(stored) : null;
        } catch { return null; }
      },

      saveToStorage() {
        const vals = this.getInputValues();
        try { localStorage.setItem(WEALTH_STORAGE_KEY, JSON.stringify(vals)); } catch (_) {}
      },

      getInputValues() {
        return {
          preTaxReturn: document.getElementById('wealth-preTaxReturn')?.value ?? '7.30',
          taxRate: document.getElementById('wealth-taxRate')?.value ?? '30.00',
          costOfLiving: document.getElementById('wealth-costOfLiving')?.value ?? '1500000',
          inflation: document.getElementById('wealth-inflation')?.value ?? '3.0',
          homeAppreciation: document.getElementById('wealth-homeAppreciation')?.value ?? '3',
          downsizeHouseYear: document.getElementById('wealth-downsizeHouseYear')?.value ?? '2037',
          downsizeHouseAmount: document.getElementById('wealth-downsizeHouseAmount')?.value ?? '10000000',
          downsizeCOLYear: document.getElementById('wealth-downsizeCOLYear')?.value ?? '2037',
          downsizeCOLAmount: document.getElementById('wealth-downsizeCOLAmount')?.value ?? '-200000'
        };
      },

      setInputValues(vals) {
        const merged = { ...wealthProjectionDefaults, ...vals };
        const ids = ['wealth-preTaxReturn','wealth-taxRate','wealth-costOfLiving','wealth-inflation','wealth-homeAppreciation','wealth-downsizeHouseYear','wealth-downsizeHouseAmount','wealth-downsizeCOLYear','wealth-downsizeCOLAmount'];
        const keys = ['preTaxReturn','taxRate','costOfLiving','inflation','homeAppreciation','downsizeHouseYear','downsizeHouseAmount','downsizeCOLYear','downsizeCOLAmount'];
        keys.forEach((k, i) => { const el = document.getElementById(ids[i]); if (el) el.value = merged[k] ?? wealthProjectionDefaults[k]; });
      },

      reset() {
        this.setInputValues(wealthProjectionDefaults);
        this.saveToStorage();
        this.updateNetReturnDisplay();
        this.update();
      },

      getInputs() {
        const preTax = parseFloat(document.getElementById('wealth-preTaxReturn')?.value) || 0;
        const taxRate = parseFloat(document.getElementById('wealth-taxRate')?.value) || 0;
        const costOfLiving = parseFloat(document.getElementById('wealth-costOfLiving')?.value) || 0;
        const inflation = parseFloat(document.getElementById('wealth-inflation')?.value) || 0;
        const homeAppreciation = parseFloat(document.getElementById('wealth-homeAppreciation')?.value) || 0;
        const downsizeHouseYear = parseInt(document.getElementById('wealth-downsizeHouseYear')?.value, 10) || 0;
        const downsizeHouseAmount = parseFloat(document.getElementById('wealth-downsizeHouseAmount')?.value) || 0;
        const downsizeCOLYear = parseInt(document.getElementById('wealth-downsizeCOLYear')?.value, 10) || 0;
        const downsizeCOLAmount = parseFloat(document.getElementById('wealth-downsizeCOLAmount')?.value) || 0;
        const netReturnPct = preTax * (1 - taxRate / 100);
        return { preTax, taxRate, costOfLiving, inflation, homeAppreciation, netReturnPct, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount };
      },

      updateNetReturnDisplay() {
        const { netReturnPct } = this.getInputs();
        document.getElementById('wealth-netReturn').textContent = netReturnPct.toFixed(2);
      },

      computeProjection(startingWealth, netReturnDec, costOfLiving, inflationDec, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount) {
        const values = [startingWealth];
        let effectiveCOL = costOfLiving;
        for (let t = 1; t < this.numYears; t++) {
          const year = this.startYear + t;
          if (year === downsizeCOLYear) effectiveCOL = Math.max(0, effectiveCOL + downsizeCOLAmount);
          let growth = values[t - 1] * (1 + netReturnDec);
          if (year === downsizeHouseYear) growth += downsizeHouseAmount;
          values.push(Math.max(0, growth - effectiveCOL));
          effectiveCOL = effectiveCOL * (1 + inflationDec);
        }
        return values;
      },

      computeRealEstate(startingRealEstate, homeApprecDec, downsizeHouseYear, downsizeHouseAmount) {
        const values = [startingRealEstate];
        let re = startingRealEstate;
        for (let t = 1; t < this.numYears; t++) {
          const year = this.startYear + t;
          re = re * (1 + homeApprecDec);
          if (year === downsizeHouseYear) re = Math.max(0, re - downsizeHouseAmount);
          values.push(re);
        }
        return values;
      },

      computeBreakdown(startingWealth, netReturnDec, costOfLiving, inflationDec, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount) {
        const rows = [{ year: this.startYear, netInvestment: startingWealth, postTaxEarnings: 0, costOfLiving: 0 }];
        let wealth = startingWealth;
        let effectiveCOL = costOfLiving;
        for (let t = 1; t < this.numYears; t++) {
          const year = this.startYear + t;
          if (year === downsizeCOLYear) effectiveCOL = Math.max(0, effectiveCOL + downsizeCOLAmount);
          const postTaxEarnings = wealth * netReturnDec;
          let nextWealth = wealth + postTaxEarnings - effectiveCOL;
          if (year === downsizeHouseYear) nextWealth += downsizeHouseAmount;
          rows.push({ year, netInvestment: Math.max(0, nextWealth), postTaxEarnings, costOfLiving: effectiveCOL });
          wealth = nextWealth;
          effectiveCOL = effectiveCOL * (1 + inflationDec);
        }
        return rows;
      },

      renderBreakdown() {
        const el = document.getElementById('wealth-breakdown');
        if (!el || this.startingWealth == null) return;
        const { netReturnPct, costOfLiving, inflation, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount } = this.getInputs();
        const rows = this.computeBreakdown(this.startingWealth, netReturnPct / 100, costOfLiving, inflation / 100, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount);
        const fmt = n => '$' + Math.round(n).toLocaleString();
        const pct = n => (n * 100).toFixed(2) + '%';
        const ret = (r, i) => i === 0 ? '—' : r.postTaxEarnings && rows[i - 1].netInvestment ? pct(r.postTaxEarnings / rows[i - 1].netInvestment) : '—';
        const infl = (r, i) => i === 0 || !rows[i - 1].costOfLiving ? '—' : pct((r.costOfLiving / rows[i - 1].costOfLiving) - 1);
        el.innerHTML = '<table style="border-collapse: collapse; width: 100%;"><thead><tr><th style="text-align:left;padding:2px 8px;border-bottom:1px solid #ccc">Year</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Net Investment</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Post-Tax Earnings</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Return</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Cost of Living</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Inflation</th></tr></thead><tbody>' +
          rows.map((r, i) => `<tr><td style="padding:2px 8px">${r.year}</td><td style="text-align:right;padding:2px 8px">${fmt(r.netInvestment)}</td><td style="text-align:right;padding:2px 8px">${fmt(r.postTaxEarnings)}</td><td style="text-align:right;padding:2px 8px">${ret(r, i)}</td><td style="text-align:right;padding:2px 8px">${fmt(r.costOfLiving)}</td><td style="text-align:right;padding:2px 8px">${infl(r, i)}</td></tr>`).join('') + '</tbody></table>';
      },

      update() {
        const { netReturnPct, costOfLiving, inflation, homeAppreciation, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount } = this.getInputs();
        const netReturnDec = netReturnPct / 100;
        const inflationDec = inflation / 100;
        const homeApprecDec = homeAppreciation / 100;
        const startingWealth = this.startingWealth;
        const startingRealEstate = this.startingRealEstate;
        if (startingWealth == null || !this.instance) return;
        const netInv = this.computeProjection(startingWealth, netReturnDec, costOfLiving, inflationDec, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount);
        const realEstate = this.computeRealEstate(startingRealEstate, homeApprecDec, downsizeHouseYear, downsizeHouseAmount);
        const netWorth = netInv.map((v, i) => v + realEstate[i]);
        this.instance.data.datasets[0].data = netInv;
        this.instance.data.datasets[1].data = realEstate;
        this.instance.data.datasets[2].data = netWorth;
        this.instance.update();
        this.renderBreakdown();
      },

      show() { setChartVisible(this.id, true); },
      hide() { setChartVisible(this.id, false); },

      async init() {
        const response = await fetch(csvPath);
        const text = await response.text();
        const lines = text.trim().split('\n');
        const data = lines.slice(1).filter(line => line.trim());
        const lastRow = data[data.length - 1];
        const cols = lastRow ? lastRow.split(',') : [];
        this.startingWealth = cols[4] ? parseFloat(cols[4]) : 0;
        this.startingRealEstate = cols[2] ? parseFloat(cols[2]) : 0;

        const labels = [];
        for (let y = this.startYear; y < this.startYear + this.numYears; y++) labels.push(y % 100);

        const { netReturnPct, costOfLiving, inflation, homeAppreciation, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount } = this.getInputs();
        const netReturnDec = netReturnPct / 100;
        const inflationDec = inflation / 100;
        const homeApprecDec = homeAppreciation / 100;
        const netInv = this.computeProjection(this.startingWealth, netReturnDec, costOfLiving, inflationDec, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount);
        const realEstate = this.computeRealEstate(this.startingRealEstate, homeApprecDec, downsizeHouseYear, downsizeHouseAmount);
        const netWorth = netInv.map((v, i) => v + realEstate[i]);

        const ctx = document.getElementById('wealthProjection-canvas').getContext('2d');
        this.instance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { data: netInv, order: 3, borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.2)', fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4, borderWidth: 4 },
              { data: realEstate, order: 2, borderColor: '#ef4444', fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 4, borderWidth: 4 },
              { data: netWorth, order: 1, borderColor: '#22c55e', fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 4, borderWidth: 4 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            plugins: { legend: { display: false }, tooltip: { animation: { duration: 0 }, callbacks: { label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) } } },
            scales: {
              x: { title: { display: false }, grid: { display: false }, ticks: { color: '#555', font: { size: 11 }, maxRotation: 0 } },
              y: {
                min: 0, max: 100000000,
                title: { display: true, text: 'Projected wealth ($)', color: '#555', font: { size: 11 } },
                grid: { color: 'rgba(0,0,0,0.06)' },
                ticks: { color: '#555', font: { size: 11 }, stepSize: 10000000, callback: value => '$' + (value / 1000000) + 'M' }
              }
            }
          }
        });

        const stored = this.loadStored();
        if (stored) this.setInputValues(stored);
        else this.setInputValues(wealthProjectionDefaults);
        this.update();

        ['wealth-preTaxReturn', 'wealth-taxRate', 'wealth-costOfLiving', 'wealth-inflation', 'wealth-homeAppreciation', 'wealth-downsizeHouseYear', 'wealth-downsizeHouseAmount', 'wealth-downsizeCOLYear', 'wealth-downsizeCOLAmount'].forEach(id => {
          const el = document.getElementById(id);
          el.addEventListener('input', () => { this.updateNetReturnDisplay(); this.update(); this.saveToStorage(); });
          el.addEventListener('change', () => { this.updateNetReturnDisplay(); this.update(); this.saveToStorage(); });
        });
        document.getElementById('wealth-reset').addEventListener('click', () => this.reset());
        this.updateNetReturnDisplay();
        this.renderBreakdown();
      }
    };

    const monteCarloDefaults = { simulations: '10000', returnVolatility: '17', homeApprecVolatility: '5', inflationVolatility: '1.5', inflationReturnCorr: '-0.3' };
    const MC_STORAGE_KEY = 'financial-snapshot-montecarlo-inputs';

    // Monte Carlo chart
    const monteCarloChart = {
      id: 'wealth-montecarlo',
      instance: null,
      startYear: 2026,
      numYears: 41,
      startingWealth: null,
      startingRealEstate: null,

      loadStored() {
        try {
          const stored = localStorage.getItem(MC_STORAGE_KEY);
          return stored ? JSON.parse(stored) : null;
        } catch { return null; }
      },

      saveToStorage() {
        const vals = { simulations: document.getElementById('mc-simulations')?.value ?? '10000', returnVolatility: document.getElementById('mc-returnVolatility')?.value ?? '17', homeApprecVolatility: document.getElementById('mc-homeApprecVolatility')?.value ?? '5', inflationVolatility: document.getElementById('mc-inflationVolatility')?.value ?? '1.5', inflationReturnCorr: document.getElementById('mc-inflationReturnCorr')?.value ?? '-0.3' };
        try { localStorage.setItem(MC_STORAGE_KEY, JSON.stringify(vals)); } catch (_) {}
      },

      setInputValues(vals) {
        const merged = { ...monteCarloDefaults, ...vals };
        const el = id => document.getElementById(id);
        if (el('mc-simulations')) el('mc-simulations').value = merged.simulations ?? monteCarloDefaults.simulations;
        if (el('mc-returnVolatility')) el('mc-returnVolatility').value = merged.returnVolatility ?? monteCarloDefaults.returnVolatility;
        if (el('mc-homeApprecVolatility')) el('mc-homeApprecVolatility').value = merged.homeApprecVolatility ?? monteCarloDefaults.homeApprecVolatility;
        if (el('mc-inflationVolatility')) el('mc-inflationVolatility').value = merged.inflationVolatility ?? monteCarloDefaults.inflationVolatility;
        if (el('mc-inflationReturnCorr')) el('mc-inflationReturnCorr').value = merged.inflationReturnCorr ?? monteCarloDefaults.inflationReturnCorr;
      },

      reset() {
        this.setInputValues(monteCarloDefaults);
        this.saveToStorage();
        this.update();
      },

      getInputs() {
        const wp = wealthProjectionChart.getInputs();
        const sims = parseInt(document.getElementById('mc-simulations')?.value, 10) || 10000;
        const vol = parseFloat(document.getElementById('mc-returnVolatility')?.value) || 17;
        const homeVol = parseFloat(document.getElementById('mc-homeApprecVolatility')?.value) || 5;
        const inflationVol = parseFloat(document.getElementById('mc-inflationVolatility')?.value) || 1.5;
        const corr = parseFloat(document.getElementById('mc-inflationReturnCorr')?.value);
        const inflationReturnCorr = !isNaN(corr) ? Math.max(-1, Math.min(1, corr)) : -0.3;
        return { ...wp, simulations: Math.min(5000, Math.max(100, sims)), returnVolatility: vol, homeApprecVolatility: homeVol, inflationVolatility: inflationVol, inflationReturnCorr };
      },

      computeRealEstatePath(startingRealEstate, downsizeHouseYear, downsizeHouseAmount, getAppreciation) {
        const values = [startingRealEstate];
        let re = startingRealEstate;
        for (let t = 1; t < this.numYears; t++) {
          const year = this.startYear + t;
          re = re * (1 + getAppreciation(t));
          if (year === downsizeHouseYear) re = Math.max(0, re - downsizeHouseAmount);
          values.push(re);
        }
        return values;
      },

      computePath(startingWealth, costOfLiving, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount, getReturnAndInflation) {
        const values = [startingWealth];
        const colPath = [0];
        let effectiveCOL = costOfLiving;
        for (let t = 1; t < this.numYears; t++) {
          const year = this.startYear + t;
          if (year === downsizeCOLYear) effectiveCOL = Math.max(0, effectiveCOL + downsizeCOLAmount);
          colPath.push(effectiveCOL);
          const { return: r, inflation: infl } = getReturnAndInflation(t);
          let growth = values[t - 1] * (1 + r);
          if (year === downsizeHouseYear) growth += downsizeHouseAmount;
          values.push(Math.max(0, growth - effectiveCOL));
          effectiveCOL = effectiveCOL * (1 + Math.max(0.01, infl));
        }
        return { values, colPath };
      },

      runSimulations() {
        const { netReturnPct, costOfLiving, inflation, homeAppreciation, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount, simulations, returnVolatility, homeApprecVolatility, inflationVolatility, inflationReturnCorr } = this.getInputs();
        const netReturnDec = netReturnPct / 100;
        const volDec = returnVolatility / 100;
        const homeApprecDec = homeAppreciation / 100;
        const homeVolDec = homeApprecVolatility / 100;
        const inflationDec = inflation / 100;
        const inflationVolDec = inflationVolatility / 100;
        const rho = Math.max(-0.99, Math.min(0.99, inflationReturnCorr));
        const rhoAdj = Math.sqrt(1 - rho * rho);

        const netInvPaths = [];
        const colPaths = [];
        const realEstatePaths = [];
        const netWorthPaths = [];

        for (let i = 0; i < simulations; i++) {
          const getReturnAndInflation = () => {
            const z1 = normalRandom(0, 1);
            const z2 = normalRandom(0, 1);
            const infl = inflationDec + inflationVolDec * z1;
            const r = netReturnDec + volDec * (rho * z1 + rhoAdj * z2);
            return { return: Math.max(-0.5, r), inflation: Math.max(0.01, infl) };
          };
          const inflCache = [];
          const retCache = [];
          for (let t = 1; t < this.numYears; t++) {
            const draw = getReturnAndInflation();
            inflCache.push(draw.inflation);
            retCache.push(draw.return);
          }
          const { values: netInv, colPath } = this.computePath(
            this.startingWealth, costOfLiving, downsizeHouseYear, downsizeHouseAmount, downsizeCOLYear, downsizeCOLAmount,
            (t) => ({ return: retCache[t - 1], inflation: inflCache[t - 1] })
          );
          colPaths.push(colPath);
          const realEstate = this.computeRealEstatePath(
            this.startingRealEstate, downsizeHouseYear, downsizeHouseAmount,
            () => Math.max(-0.3, normalRandom(homeApprecDec, homeVolDec))
          );
          netInvPaths.push(netInv);
          realEstatePaths.push(realEstate);
          netWorthPaths.push(netInv.map((v, j) => v + realEstate[j]));
        }

        function calcPercentiles(paths) {
          const p10 = [], p25 = [], p50 = [], p75 = [], p90 = [];
          for (let t = 0; t < monteCarloChart.numYears; t++) {
            const vals = paths.map(p => p[t]);
            p10.push(percentile(vals, 10));
            p25.push(percentile(vals, 25));
            p50.push(percentile(vals, 50));
            p75.push(percentile(vals, 75));
            p90.push(percentile(vals, 90));
          }
          return { p10, p25, p50, p75, p90 };
        }

        function pickSamples(paths, n) {
          const out = [];
          for (let i = 0; i < n; i++) out.push(paths[Math.floor(Math.random() * paths.length)]);
          return out;
        }

        const medianCOL = [];
        for (let t = 0; t < this.numYears; t++) {
          const vals = colPaths.map(p => p[t]);
          medianCOL.push(percentile(vals, 50));
        }

        return {
          netInv: { ...calcPercentiles(netInvPaths), samples: pickSamples(netInvPaths, 5) },
          realEstate: { ...calcPercentiles(realEstatePaths), samples: pickSamples(realEstatePaths, 5) },
          netWorth: { ...calcPercentiles(netWorthPaths), samples: pickSamples(netWorthPaths, 5) },
          medianCOL
        };
      },

      computeBreakdownFromMedian(medianNetInv, medianCOL) {
        const rows = [{ year: this.startYear, netInvestment: medianNetInv[0], postTaxEarnings: 0, costOfLiving: 0 }];
        for (let t = 1; t < this.numYears; t++) {
          const year = this.startYear + t;
          const effectiveCOL = medianCOL[t];
          const postTaxEarnings = Math.max(0, medianNetInv[t] - medianNetInv[t - 1] + effectiveCOL);
          rows.push({ year, netInvestment: medianNetInv[t], postTaxEarnings, costOfLiving: effectiveCOL });
        }
        return rows;
      },

      renderBreakdown(runResult) {
        const el = document.getElementById('mc-breakdown');
        if (!el || this.startingWealth == null) return;
        const r = runResult || this.runSimulations();
        const rows = this.computeBreakdownFromMedian(r.netInv.p50, r.medianCOL);
        const fmt = n => '$' + Math.round(n).toLocaleString();
        const pct = n => (n * 100).toFixed(2) + '%';
        const ret = (rr, i) => i === 0 ? '—' : rr.postTaxEarnings && rows[i - 1].netInvestment ? pct(rr.postTaxEarnings / rows[i - 1].netInvestment) : '—';
        const infl = (rr, i) => i === 0 || !rows[i - 1].costOfLiving ? '—' : pct((rr.costOfLiving / rows[i - 1].costOfLiving) - 1);
        el.innerHTML = '<table style="border-collapse: collapse; width: 100%;"><thead><tr><th style="text-align:left;padding:2px 8px;border-bottom:1px solid #ccc">Year</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Net Investment</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Post-Tax Earnings</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Return</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Cost of Living</th><th style="text-align:right;padding:2px 8px;border-bottom:1px solid #ccc">Inflation</th></tr></thead><tbody>' +
          rows.map((rr, i) => `<tr><td style="padding:2px 8px">${rr.year}</td><td style="text-align:right;padding:2px 8px">${fmt(rr.netInvestment)}</td><td style="text-align:right;padding:2px 8px">${fmt(rr.postTaxEarnings)}</td><td style="text-align:right;padding:2px 8px">${ret(rr, i)}</td><td style="text-align:right;padding:2px 8px">${fmt(rr.costOfLiving)}</td><td style="text-align:right;padding:2px 8px">${infl(rr, i)}</td></tr>`).join('') + '</tbody></table>';
      },

      update() {
        if (this.startingWealth == null || !this.instance) return;
        const r = this.runSimulations();
        const d = this.instance.data.datasets;

        [r.realEstate.p10, r.realEstate.p25, r.realEstate.p50, r.realEstate.p75, r.realEstate.p90, ...r.realEstate.samples].forEach((data, i) => d[i].data = data);
        [r.netInv.p10, r.netInv.p25, r.netInv.p50, r.netInv.p75, r.netInv.p90, ...r.netInv.samples].forEach((data, i) => d[10 + i].data = data);
        [r.netWorth.p10, r.netWorth.p25, r.netWorth.p50, r.netWorth.p75, r.netWorth.p90, ...r.netWorth.samples].forEach((data, i) => d[20 + i].data = data);
        this.instance.update();
        this.renderBreakdown(r);
      },

      show() { setChartVisible(this.id, true); },
      hide() { setChartVisible(this.id, false); },

      async init() {
        const response = await fetch(csvPath);
        const text = await response.text();
        const lines = text.trim().split('\n');
        const data = lines.slice(1).filter(line => line.trim());
        const lastRow = data[data.length - 1];
        const cols = lastRow ? lastRow.split(',') : [];
        this.startingWealth = cols[4] ? parseFloat(cols[4]) : 0;
        this.startingRealEstate = cols[2] ? parseFloat(cols[2]) : 0;

        const stored = this.loadStored();
        if (stored) this.setInputValues(stored);
        else this.setInputValues(monteCarloDefaults);

        const labels = [];
        for (let y = this.startYear; y < this.startYear + this.numYears; y++) labels.push(y % 100);

        const r = this.runSimulations();
        const blue = '#0ea5e9', red = '#ef4444', green = '#22c55e';

        const ctx = document.getElementById('wealthMonteCarlo-canvas').getContext('2d');
        this.instance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              ...['p10','p25','p50','p75','p90'].map((k, i) => ({ data: r.realEstate[k], order: 30, borderColor: red, fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 2, borderWidth: i === 2 ? 5 : (i === 1 || i === 3) ? 2 : 1 })),
              ...r.realEstate.samples.map((d, i) => ({ data: d, order: 29, borderColor: 'rgba(239,68,68,0.2)', fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 2, borderWidth: 1 })),
              ...['p10','p25','p50','p75','p90'].map((k, i) => ({ data: r.netInv[k], order: 20, borderColor: blue, fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 2, borderWidth: i === 2 ? 5 : (i === 1 || i === 3) ? 2 : 1 })),
              ...r.netInv.samples.map((d, i) => ({ data: d, order: 19, borderColor: 'rgba(14,165,233,0.2)', fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 2, borderWidth: 1 })),
              ...['p10','p25','p50','p75','p90'].map((k, i) => ({ data: r.netWorth[k], order: 10, borderColor: green, fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 2, borderWidth: i === 2 ? 5 : (i === 1 || i === 3) ? 2 : 1 })),
              ...r.netWorth.samples.map((d, i) => ({ data: d, order: 9, borderColor: 'rgba(34,197,94,0.2)', fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 2, borderWidth: 1 }))
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            plugins: { legend: { display: false }, tooltip: { animation: { duration: 0 }, callbacks: { label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) } } },
            scales: {
              x: { title: { display: false }, grid: { display: false }, ticks: { color: '#555', font: { size: 11 }, maxRotation: 0 } },
              y: {
                min: 0, max: 100000000,
                title: { display: true, text: 'Net worth ($)', color: '#555', font: { size: 11 } },
                grid: { color: 'rgba(0,0,0,0.06)' },
                ticks: { color: '#555', font: { size: 11 }, stepSize: 10000000, callback: value => '$' + (value / 1000000) + 'M' }
              }
            }
          }
        });

        this.renderBreakdown(r);

        ['mc-simulations', 'mc-returnVolatility', 'mc-homeApprecVolatility', 'mc-inflationVolatility', 'mc-inflationReturnCorr'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.addEventListener('input', () => { this.update(); this.saveToStorage(); }); el.addEventListener('change', () => { this.update(); this.saveToStorage(); }); }
        });
        document.getElementById('mc-rerun')?.addEventListener('click', () => this.update());
        document.getElementById('mc-reset')?.addEventListener('click', () => this.reset());

        ['wealth-preTaxReturn', 'wealth-taxRate', 'wealth-costOfLiving', 'wealth-inflation', 'wealth-homeAppreciation', 'wealth-downsizeHouseYear', 'wealth-downsizeHouseAmount', 'wealth-downsizeCOLYear', 'wealth-downsizeCOLAmount'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.addEventListener('input', () => this.update()); el.addEventListener('change', () => this.update()); }
        });
      }
    };

    // Initialize all charts (reorder sections in HTML to change display order)
    (async () => {
      await netInvestmentsChart.init();
      await wealthProjectionChart.init();
      await monteCarloChart.init();
    })().catch(err => {
      document.body.innerHTML = '<h1>Error loading data</h1><p>' + err.message + '</p><p>Make sure to run a local server from this folder (e.g. <code>python -m http.server 8000</code>) and open the page via localhost.</p>';
    });
  </script>
</body>
</html>
